!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("vega-dataflow"),require("vega-util"),require("d3-force")):"function"==typeof define&&define.amd?define(["exports","vega-dataflow","vega-util","d3-force"],t):t((e.vega=e.vega||{},e.vega.transforms={}),e.vega,e.vega,e.d3)}(this,function(e,t,s,p){"use strict";var n={center:p.forceCenter,collide:p.forceCollide,nbody:p.forceManyBody,link:p.forceLink,x:p.forceX,y:p.forceY},d="forces",y=["alpha","alphaMin","alphaTarget","velocityDecay","forces"],h=["static","iterations"],l=["x","y","vx","vy"];function a(e){t.Transform.call(this,null,e)}a.Definition={type:"Force",metadata:{modifies:!0},params:[{name:"static",type:"boolean",default:!1},{name:"restart",type:"boolean",default:!1},{name:"iterations",type:"number",default:300},{name:"alpha",type:"number",default:1},{name:"alphaMin",type:"number",default:.001},{name:"alphaTarget",type:"number",default:0},{name:"velocityDecay",type:"number",default:.4},{name:"forces",type:"param",array:!0,params:[{key:{force:"center"},params:[{name:"x",type:"number",default:0},{name:"y",type:"number",default:0}]},{key:{force:"collide"},params:[{name:"radius",type:"number",expr:!0},{name:"strength",type:"number",default:.7},{name:"iterations",type:"number",default:1}]},{key:{force:"nbody"},params:[{name:"strength",type:"number",default:-30},{name:"theta",type:"number",default:.9},{name:"distanceMin",type:"number",default:1},{name:"distanceMax",type:"number"}]},{key:{force:"link"},params:[{name:"links",type:"data"},{name:"id",type:"field"},{name:"distance",type:"number",default:30,expr:!0},{name:"strength",type:"number",expr:!0},{name:"iterations",type:"number",default:1}]},{key:{force:"x"},params:[{name:"strength",type:"number",default:.1},{name:"x",type:"field"}]},{key:{force:"y"},params:[{name:"strength",type:"number",default:.1},{name:"y",type:"field"}]}]},{name:"as",type:"string",array:!0,modify:!1,default:l}]};var r=s.inherits(a,t.Transform);function g(e,t,a,n){var r,o,i,f,u=s.array(t.forces);for(r=0,o=y.length;r<o;++r)(i=y[r])!==d&&t.modified(i)&&e[i](t[i]);for(r=0,o=u.length;r<o;++r)f=d+r,(i=a||t.modified(d,r)?m(u[r]):n&&c(u[r],n)?e.force(f):null)&&e.force(f,i);for(o=e.numForces||0;r<o;++r)e.force(d+r,null);return e.numForces=u.length,e}function c(e,t){var a,n;for(a in e)if(s.isFunction(n=e[a])&&t.modified(s.accessorFields(n)))return 1;return 0}function m(e){var t,a;for(a in n.hasOwnProperty(e.force)||s.error("Unrecognized force: "+e.force),t=n[e.force](),e)s.isFunction(t[a])&&o(t[a],e[a],e);return t}function o(e,t,a){e(s.isFunction(t)?function(e){return t(e,a)}:t)}r.transform=function(e,t){var a,n,r,o,i,f,u,s,c=this.value,d=t.changed(t.ADD_REM),l=e.modified(y),m=e.iterations||300;if(c?(d&&(t.modifies("index"),c.nodes(t.source)),(l||t.changed(t.MOD))&&g(c,e,0,t)):(this.value=(r=t.source,o=e,i=p.forceSimulation(r),f=!1,u=i.stop,s=i.restart,i.stopped=function(){return f},i.restart=function(){return f=!1,s()},i.stop=function(){return f=!0,u()},c=g(i,o,!0).on("end",function(){f=!0})),c.on("tick",(a=t.dataflow,n=this,function(){a.touch(n).run()})),e.static||(d=!0,c.tick()),t.modifies("index")),l||d||e.modified(h)||t.changed()&&e.restart)if(c.alpha(Math.max(c.alpha(),e.alpha||1)).alphaDecay(1-Math.pow(c.alphaMin(),1/m)),e.static)for(c.stop();0<=--m;)c.tick();else if(c.stopped()&&c.restart(),!d)return t.StopPropagation;return this.finish(e,t)},r.finish=function(e,t){for(var a,n=t.dataflow,r=this._argops,o=0,i=r.length;o<i;++o)if((a=r[o]).name===d&&"link"===a.op._argval.force)for(var f,u=a.op._argops,s=0,c=u.length;s<c;++s)if("links"===u[s].name&&(f=u[s].op.source)){n.pulse(f,n.changeset().reflow());break}return t.reflow(e.modified()).modifies(l)},e.force=a,Object.defineProperty(e,"__esModule",{value:!0})});