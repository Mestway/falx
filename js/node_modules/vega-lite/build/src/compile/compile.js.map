{"version":3,"file":"compile.js","sourceRoot":"","sources":["../../../src/compile/compile.ts"],"names":[],"mappings":"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","sourcesContent":["import {Spec as VgSpec} from 'vega';\nimport {Config, initConfig, stripAndRedirectConfig} from '../config';\nimport * as vlFieldDef from '../fielddef';\nimport * as log from '../log';\nimport {isLayerSpec, isUnitSpec, LayoutSizeMixins, normalize, TopLevel, TopLevelSpec} from '../spec';\nimport {\n  AutoSizeParams,\n  Datasets,\n  extractTopLevelProperties,\n  normalizeAutoSize,\n  TopLevelProperties\n} from '../spec/toplevel';\nimport {keys, mergeDeep} from '../util';\nimport {buildModel} from './buildmodel';\nimport {assembleRootData} from './data/assemble';\nimport {optimizeDataflow} from './data/optimize';\nimport {Model} from './model';\n\nexport interface CompileOptions {\n  config?: Config;\n  logger?: log.LoggerInterface;\n\n  fieldTitle?: vlFieldDef.FieldTitleFormatter;\n}\n\n/**\n * Vega-Lite's main function, for compiling Vega-lite spec into Vega spec.\n *\n * At a high-level, we make the following transformations in different phases:\n *\n * Input spec\n *     |\n *     |  (Normalization)\n *     v\n * Normalized Spec (Row/Column channels in single-view specs becomes faceted specs, composite marks becomes layered specs.)\n *     |\n *     |  (Build Model)\n *     v\n * A model tree of the spec\n *     |\n *     |  (Parse)\n *     v\n * A model tree with parsed components (intermediate structure of visualization primitives in a format that can be easily merged)\n *     |\n *     | (Optimize)\n *     v\n * A model tree with parsed components with the data component optimized\n *     |\n *     | (Assemble)\n *     v\n * Vega spec\n */\nexport function compile(inputSpec: TopLevelSpec, opt: CompileOptions = {}) {\n  // 0. Augment opt with default opts\n  if (opt.logger) {\n    // set the singleton logger to the provided logger\n    log.set(opt.logger);\n  }\n\n  if (opt.fieldTitle) {\n    // set the singleton field title formatter\n    vlFieldDef.setTitleFormatter(opt.fieldTitle);\n  }\n\n  try {\n    // 1. Initialize config by deep merging default config with the config provided via option and the input spec.\n    const config = initConfig(mergeDeep({}, opt.config, inputSpec.config));\n\n    // 2. Normalize: Convert input spec -> normalized spec\n\n    // - Decompose all extended unit specs into composition of unit spec.  For example, a box plot get expanded into multiple layers of bars, ticks, and rules. The shorthand row/column channel is also expanded to a facet spec.\n    const spec = normalize(inputSpec, config);\n    // - Normalize autosize to be a autosize properties object.\n    const autosize = normalizeAutoSize(inputSpec.autosize, config.autosize, isLayerSpec(spec) || isUnitSpec(spec));\n\n    // 3. Build Model: normalized spec -> Model (a tree structure)\n\n    // This phases instantiates the models with default config by doing a top-down traversal. This allows us to pass properties that child models derive from their parents via their constructors.\n    // See the abstract `Model` class and its children (UnitModel, LayerModel, FacetModel, RepeatModel, ConcatModel) for different types of models.\n    const model: Model = buildModel(spec, null, '', undefined, undefined, config, autosize.type === 'fit');\n\n    // 4 Parse: Model --> Model with components\n\n    // Note that components = intermediate representations that are equivalent to Vega specs.\n    // We need these intermediate representation because we need to merge many visualization \"components\" like projections, scales, axes, and legends.\n    // We will later convert these components into actual Vega specs in the assemble phase.\n\n    // In this phase, we do a bottom-up traversal over the whole tree to\n    // parse for each type of components once (e.g., data, layout, mark, scale).\n    // By doing bottom-up traversal, we start parsing components of unit specs and\n    // then merge child components of parent composite specs.\n    //\n    // Please see inside model.parse() for order of different components parsed.\n    model.parse();\n\n    // 5. Optimize the dataflow.  This will modify the data component of the model.\n    optimizeDataflow(model.component.data);\n\n    // 6. Assemble: convert model components --> Vega Spec.\n    return assembleTopLevelModel(\n      model,\n      getTopLevelProperties(inputSpec, config, autosize),\n      inputSpec.datasets,\n      inputSpec.usermeta\n    );\n  } finally {\n    // Reset the singleton logger if a logger is provided\n    if (opt.logger) {\n      log.reset();\n    }\n    // Reset the singleton field title formatter if provided\n    if (opt.fieldTitle) {\n      vlFieldDef.resetTitleFormatter();\n    }\n  }\n}\n\nfunction getTopLevelProperties(topLevelSpec: TopLevel<any>, config: Config, autosize: AutoSizeParams) {\n  return {\n    autosize: keys(autosize).length === 1 && autosize.type ? autosize.type : autosize,\n    ...extractTopLevelProperties(config),\n    ...extractTopLevelProperties(topLevelSpec)\n  };\n}\n\n/*\n * Assemble the top-level model.\n *\n * Note: this couldn't be `model.assemble()` since the top-level model\n * needs some special treatment to generate top-level properties.\n */\nfunction assembleTopLevelModel(\n  model: Model,\n  topLevelProperties: TopLevelProperties & LayoutSizeMixins,\n  datasets: Datasets = {},\n  usermeta: object\n) {\n  // TODO: change type to become VgSpec\n\n  // Config with Vega-Lite only config removed.\n  const vgConfig = model.config ? stripAndRedirectConfig(model.config) : undefined;\n\n  const data = [].concat(\n    model.assembleSelectionData([]),\n    // only assemble data in the root\n    assembleRootData(model.component.data, datasets)\n  );\n\n  const projections = model.assembleProjections();\n  const title = model.assembleTitle();\n  const style = model.assembleGroupStyle();\n\n  let layoutSignals = model.assembleLayoutSignals();\n\n  // move width and height signals with values to top level\n  layoutSignals = layoutSignals.filter(signal => {\n    if ((signal.name === 'width' || signal.name === 'height') && signal.value !== undefined) {\n      topLevelProperties[signal.name] = +signal.value;\n      return false;\n    }\n    return true;\n  });\n\n  const output: VgSpec = {\n    $schema: 'https://vega.github.io/schema/vega/v4.json',\n    ...(model.description ? {description: model.description} : {}),\n    ...topLevelProperties,\n    ...(title ? {title} : {}),\n    ...(style ? {style} : {}),\n    data: data,\n    ...(projections.length > 0 ? {projections: projections} : {}),\n    ...model.assembleGroup([...layoutSignals, ...model.assembleSelectionTopLevelSignals([])]),\n    ...(vgConfig ? {config: vgConfig} : {}),\n    ...(usermeta ? {usermeta} : {})\n  };\n\n  return {\n    spec: output\n    // TODO: add warning / errors here\n  };\n}\n"]}