{"version":3,"file":"debug.js","sourceRoot":"","sources":["../../../../src/compile/data/debug.ts"],"names":[],"mappings":"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","sourcesContent":["import {entries, uniqueId} from './../../util';\nimport {DataFlowNode} from './dataflow';\n\n/**\n * Print debug information for dataflow tree.\n */\nexport function debug(node: DataFlowNode) {\n  console.log(\n    `${(node.constructor as any).name}${node.debugName ? `(${node.debugName})` : ''} -> ${node.children.map(c => {\n      return `${(c.constructor as any).name}${c.debugName ? ` (${c.debugName})` : ''}`;\n    })}`\n  );\n  console.log(node);\n  node.children.forEach(debug);\n}\n\n/**\n * Print the dataflow tree as graphviz.\n *\n * Render the output in http://viz-js.com/.\n */\nexport function draw(roots: DataFlowNode[]) {\n  // check the graph before printing it since the logic below assumes a consistent graph\n  checkLinks(roots);\n\n  const nodes: {[key: string]: {id: string | number; label: string; hash: string | number}} = {};\n  const edges: [string, string][] = [];\n\n  function getId(node: DataFlowNode) {\n    let id = node['__uniqueid'];\n    if (id === undefined) {\n      id = uniqueId();\n      node['__uniqueid'] = id;\n    }\n    return id;\n  }\n\n  function getLabel(node: DataFlowNode) {\n    const out = [(node.constructor as any).name.slice(0, -4)];\n\n    if (node.debugName) {\n      out.push(`<i>${node.debugName}</i>`);\n    }\n\n    const dep = node.dependentFields();\n    if (dep.size) {\n      out.push(`<font color=\"grey\" point-size=\"10\">IN:</font> ${[...node.dependentFields()].join(', ')}`);\n    }\n    const prod = node.producedFields();\n    if (prod.size) {\n      out.push(`<font color=\"grey\" point-size=\"10\">OUT:</font> ${[...node.producedFields()].join(', ')}`);\n    }\n    return out.join('<br/>');\n  }\n\n  function collector(node: DataFlowNode) {\n    const id = getId(node);\n    nodes[id] = {\n      id: id,\n      label: getLabel(node),\n      hash: String(node.hash()).replace(/\"/g, '')\n    };\n\n    for (const child of node.children) {\n      edges.push([id, getId(child)]);\n      collector(child);\n    }\n  }\n\n  roots.forEach(n => collector(n));\n\n  const dot = `digraph DataFlow {\n  rankdir = TB;\n  node [shape=record]\n  ${entries(nodes)\n    .map(\n      ({key, value}) => `  \"${key}\" [\n    label = <${value.label}>;\n    tooltip = \"[${value.id}]&#010;${value.hash}\"\n  ]`\n    )\n    .join('\\n')}\n\n  ${edges.map(([source, target]) => `\"${source}\" -> \"${target}\"`).join(' ')}\n}`;\n\n  console.log(dot);\n\n  return dot;\n}\n\n/**\n * Iterates over a dataflow graph and checks whether all links are consistent.\n */\nexport function checkLinks(nodes: DataFlowNode[]): boolean {\n  for (const node of nodes) {\n    for (const child of node.children) {\n      if (child.parent !== node) {\n        console.error('Dataflow graph is inconsistent.', parent, child);\n        return false;\n      }\n    }\n\n    if (!checkLinks(node.children)) {\n      return false;\n    }\n  }\n\n  return true;\n}\n"]}