{"version":3,"file":"normalize.js","sourceRoot":"","sources":["../../src/normalize.ts"],"names":[],"mappings":"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","sourcesContent":["import {isObject} from 'vega-util';\nimport {COLUMN, ROW} from './channel';\nimport * as compositeMark from './compositemark';\nimport {Config} from './config';\nimport {channelHasField, Encoding} from './encoding';\nimport {Field, RepeatRef} from './fielddef';\nimport * as log from './log';\nimport {\n  AnyMark,\n  AreaConfig,\n  isMarkDef,\n  isPathMark,\n  isPrimitiveMark,\n  LineConfig,\n  Mark,\n  MarkConfig,\n  MarkDef\n} from './mark';\nimport {Projection} from './projection';\nimport {\n  CompositeUnitSpec,\n  ExtendedLayerSpec,\n  FacetedCompositeUnitSpec,\n  GenericFacetSpec,\n  GenericHConcatSpec,\n  GenericRepeatSpec,\n  GenericSpec,\n  GenericUnitSpec,\n  GenericVConcatSpec,\n  isFacetSpec,\n  isHConcatSpec,\n  isLayerSpec,\n  isRepeatSpec,\n  isUnitSpec,\n  isVConcatSpec,\n  NormalizedConcatSpec,\n  NormalizedFacetSpec,\n  NormalizedLayerSpec,\n  NormalizedRepeatSpec,\n  NormalizedSpec,\n  NormalizedUnitSpec,\n  TopLevel,\n  TopLevelSpec\n} from './spec';\nimport {stack} from './stack';\nimport {keys, omit, pick} from './util';\n\nexport function normalizeTopLevelSpec(\n  spec: TopLevelSpec | GenericSpec<CompositeUnitSpec, ExtendedLayerSpec> | FacetedCompositeUnitSpec,\n  config: Config\n): TopLevel<NormalizedSpec> {\n  return normalize(spec, config);\n}\n\n/**\n * Decompose extended unit specs into composition of pure unit specs.\n */\nfunction normalize(\n  spec: GenericSpec<CompositeUnitSpec, ExtendedLayerSpec> | FacetedCompositeUnitSpec,\n  config: Config\n): NormalizedSpec {\n  if (isFacetSpec(spec)) {\n    return normalizeFacet(spec, config);\n  }\n  if (isLayerSpec(spec)) {\n    return normalizeLayer(spec, config);\n  }\n  if (isRepeatSpec(spec)) {\n    return normalizeRepeat(spec, config);\n  }\n  if (isVConcatSpec(spec)) {\n    return normalizeVConcat(spec, config);\n  }\n  if (isHConcatSpec(spec)) {\n    return normalizeHConcat(spec, config);\n  }\n  if (isUnitSpec(spec)) {\n    const hasRow = channelHasField(spec.encoding, ROW);\n    const hasColumn = channelHasField(spec.encoding, COLUMN);\n\n    if (hasRow || hasColumn) {\n      return normalizeFacetedUnit(spec, config);\n    }\n    return normalizeNonFacetUnit(spec, config);\n  }\n  throw new Error(log.message.INVALID_SPEC);\n}\n\nfunction normalizeFacet(\n  spec: GenericFacetSpec<CompositeUnitSpec, ExtendedLayerSpec>,\n  config: Config\n): NormalizedFacetSpec {\n  const {spec: subspec, ...rest} = spec;\n  return {\n    ...rest,\n    // TODO: remove \"any\" once we support all facet listed in https://github.com/vega/vega-lite/issues/2760\n    spec: normalize(subspec, config) as any\n  };\n}\n\nfunction mergeEncoding(opt: {parentEncoding: Encoding<any>; encoding: Encoding<any>}): Encoding<any> {\n  const {parentEncoding, encoding} = opt;\n  if (parentEncoding && encoding) {\n    const overriden = keys(parentEncoding).reduce((o, key) => {\n      if (encoding[key]) {\n        o.push(key);\n      }\n      return o;\n    }, []);\n\n    if (overriden.length > 0) {\n      log.warn(log.message.encodingOverridden(overriden));\n    }\n  }\n\n  const merged = {\n    ...(parentEncoding || {}),\n    ...(encoding || {})\n  };\n  return keys(merged).length > 0 ? merged : undefined;\n}\n\nfunction mergeProjection(opt: {parentProjection: Projection; projection: Projection}) {\n  const {parentProjection, projection} = opt;\n  if (parentProjection && projection) {\n    log.warn(log.message.projectionOverridden({parentProjection, projection}));\n  }\n  return projection || parentProjection;\n}\n\nfunction normalizeLayer(\n  spec: ExtendedLayerSpec,\n  config: Config,\n  parentEncoding?: Encoding<string | RepeatRef>,\n  parentProjection?: Projection\n): NormalizedLayerSpec {\n  const {layer, encoding, projection, ...rest} = spec;\n  const mergedEncoding = mergeEncoding({parentEncoding, encoding});\n  const mergedProjection = mergeProjection({parentProjection, projection});\n  return {\n    ...rest,\n    layer: layer.map(subspec => {\n      if (isLayerSpec(subspec)) {\n        return normalizeLayer(subspec, config, mergedEncoding, mergedProjection);\n      }\n      return normalizeNonFacetUnit(subspec, config, mergedEncoding, mergedProjection);\n    })\n  };\n}\n\nfunction normalizeRepeat(\n  spec: GenericRepeatSpec<CompositeUnitSpec, ExtendedLayerSpec>,\n  config: Config\n): NormalizedRepeatSpec {\n  const {spec: subspec, ...rest} = spec;\n  return {\n    ...rest,\n    spec: normalize(subspec, config)\n  };\n}\n\nfunction normalizeVConcat(\n  spec: GenericVConcatSpec<CompositeUnitSpec, ExtendedLayerSpec>,\n  config: Config\n): NormalizedConcatSpec {\n  const {vconcat: vconcat, ...rest} = spec;\n  return {\n    ...rest,\n    vconcat: vconcat.map(subspec => normalize(subspec, config))\n  };\n}\n\nfunction normalizeHConcat(\n  spec: GenericHConcatSpec<CompositeUnitSpec, ExtendedLayerSpec>,\n  config: Config\n): NormalizedConcatSpec {\n  const {hconcat: hconcat, ...rest} = spec;\n  return {\n    ...rest,\n    hconcat: hconcat.map(subspec => normalize(subspec, config))\n  };\n}\n\nfunction normalizeFacetedUnit(spec: FacetedCompositeUnitSpec, config: Config): NormalizedFacetSpec {\n  // New encoding in the inside spec should not contain row / column\n  // as row/column should be moved to facet\n  const {row: row, column: column, ...encoding} = spec.encoding;\n\n  // Mark and encoding should be moved into the inner spec\n  const {mark, width, projection, height, selection, encoding: _, ...outerSpec} = spec;\n\n  return {\n    ...outerSpec,\n    facet: {\n      ...(row ? {row} : {}),\n      ...(column ? {column} : {})\n    },\n    spec: normalizeNonFacetUnit(\n      {\n        ...(projection ? {projection} : {}),\n        mark,\n        ...(width ? {width} : {}),\n        ...(height ? {height} : {}),\n        encoding,\n        ...(selection ? {selection} : {})\n      },\n      config\n    )\n  };\n}\n\nfunction isNonFacetUnitSpecWithPrimitiveMark(\n  spec: GenericUnitSpec<Encoding<Field>, AnyMark>\n): spec is GenericUnitSpec<Encoding<Field>, Mark> {\n  return isPrimitiveMark(spec.mark);\n}\n\nfunction getPointOverlay(markDef: MarkDef, markConfig: LineConfig, encoding: Encoding<Field>): MarkConfig {\n  if (markDef.point === 'transparent') {\n    return {opacity: 0};\n  } else if (markDef.point) {\n    // truthy : true or object\n    return isObject(markDef.point) ? markDef.point : {};\n  } else if (markDef.point !== undefined) {\n    // false or null\n    return null;\n  } else {\n    // undefined (not disabled)\n    if (markConfig.point || encoding.shape) {\n      // enable point overlay if config[mark].point is truthy or if encoding.shape is provided\n      return isObject(markConfig.point) ? markConfig.point : {};\n    }\n    // markDef.point is defined as falsy\n    return null;\n  }\n}\n\nfunction getLineOverlay(markDef: MarkDef, markConfig: AreaConfig): MarkConfig {\n  if (markDef.line) {\n    // true or object\n    return markDef.line === true ? {} : markDef.line;\n  } else if (markDef.line !== undefined) {\n    // false or null\n    return null;\n  } else {\n    // undefined (not disabled)\n    if (markConfig.line) {\n      // enable line overlay if config[mark].line is truthy\n      return markConfig.line === true ? {} : markConfig.line;\n    }\n    // markDef.point is defined as falsy\n    return null;\n  }\n}\n\nfunction normalizeNonFacetUnit(\n  spec: GenericUnitSpec<Encoding<Field>, AnyMark>,\n  config: Config,\n  parentEncoding?: Encoding<string | RepeatRef>,\n  parentProjection?: Projection\n): NormalizedUnitSpec | NormalizedLayerSpec {\n  const {encoding, projection} = spec;\n  const mark = isMarkDef(spec.mark) ? spec.mark.type : spec.mark;\n\n  // merge parent encoding / projection first\n  if (parentEncoding || parentProjection) {\n    const mergedProjection = mergeProjection({parentProjection, projection});\n    const mergedEncoding = mergeEncoding({parentEncoding, encoding});\n    return normalizeNonFacetUnit(\n      {\n        ...spec,\n        ...(mergedProjection ? {projection: mergedProjection} : {}),\n        ...(mergedEncoding ? {encoding: mergedEncoding} : {})\n      },\n      config\n    );\n  }\n\n  if (isNonFacetUnitSpecWithPrimitiveMark(spec)) {\n    // TODO: thoroughly test\n\n    if (mark === 'line' && (encoding.x2 || encoding.y2)) {\n      log.warn(log.message.lineWithRange(!!encoding.x2, !!encoding.y2));\n\n      return normalizeNonFacetUnit(\n        {\n          mark: 'rule',\n          ...spec\n        },\n        config,\n        parentEncoding,\n        parentProjection\n      );\n    }\n\n    if (isPathMark(mark)) {\n      return normalizePathOverlay(spec, config);\n    }\n\n    return spec; // Nothing to normalize\n  } else {\n    return compositeMark.normalize(spec, config);\n  }\n}\n\nfunction dropLineAndPoint(markDef: MarkDef): MarkDef | Mark {\n  const {point: _point, line: _line, ...mark} = markDef;\n\n  return keys(mark).length > 1 ? mark : mark.type;\n}\n\nfunction normalizePathOverlay(spec: NormalizedUnitSpec, config: Config = {}): NormalizedLayerSpec | NormalizedUnitSpec {\n  // _ is used to denote a dropped property of the unit spec\n  // which should not be carried over to the layer spec\n  const {selection, projection, encoding, mark, ...outerSpec} = spec;\n  const markDef = isMarkDef(mark) ? mark : {type: mark};\n\n  const pointOverlay = getPointOverlay(markDef, config[markDef.type], encoding);\n  const lineOverlay = markDef.type === 'area' && getLineOverlay(markDef, config[markDef.type]);\n\n  if (!pointOverlay && !lineOverlay) {\n    return {\n      ...spec,\n      // Do not include point / line overlay in the normalize spec\n      mark: dropLineAndPoint(markDef)\n    };\n  }\n\n  const layer: NormalizedUnitSpec[] = [\n    {\n      ...(selection ? {selection} : {}),\n      // Do not include point / line overlay in the normalize spec\n      mark: dropLineAndPoint({\n        ...markDef,\n        // make area mark translucent by default\n        // TODO: extract this 0.7 to be shared with default opacity for point/tick/...\n        ...(markDef.type === 'area' ? {opacity: 0.7} : {})\n      }),\n      // drop shape from encoding as this might be used to trigger point overlay\n      encoding: omit(encoding, ['shape'])\n    }\n  ];\n\n  // FIXME: determine rules for applying selections.\n\n  // Need to copy stack config to overlayed layer\n  const stackProps = stack(markDef, encoding, config ? config.stack : undefined);\n\n  let overlayEncoding = encoding;\n  if (stackProps) {\n    const {fieldChannel: stackFieldChannel, offset} = stackProps;\n    overlayEncoding = {\n      ...encoding,\n      [stackFieldChannel]: {\n        ...encoding[stackFieldChannel],\n        ...(offset ? {stack: offset} : {})\n      }\n    };\n  }\n\n  if (lineOverlay) {\n    layer.push({\n      ...(projection ? {projection} : {}),\n      mark: {\n        type: 'line',\n        ...pick(markDef, ['clip', 'interpolate', 'tension']),\n        ...lineOverlay\n      },\n      encoding: overlayEncoding\n    });\n  }\n  if (pointOverlay) {\n    layer.push({\n      ...(projection ? {projection} : {}),\n      mark: {\n        type: 'point',\n        opacity: 1,\n        filled: true,\n        ...pick(markDef, ['clip']),\n        ...pointOverlay\n      },\n      encoding: overlayEncoding\n    });\n  }\n\n  return {\n    ...outerSpec,\n    layer\n  };\n}\n"]}