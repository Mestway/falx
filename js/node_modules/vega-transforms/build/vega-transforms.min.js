!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("vega-statistics"),require("vega-dataflow"),require("vega-util"),require("d3-array")):"function"==typeof define&&define.amd?define(["exports","vega-statistics","vega-dataflow","vega-util","d3-array"],e):e((t.vega=t.vega||{},t.vega.transforms={}),t.vega,t.vega,t.vega,t.d3)}(this,function(t,m,b,E,d){"use strict";function v(t){return t&&t.length?1===t.length?t[0]:(a=t,function(t){for(var e=a.length,i=1,n=String(a[0](t));i<e;++i)n+="|"+a[i](t);return n}):function(){return""};var a}function O(t,e,i){return i||t+(e?"_"+e:"")}var l={values:i({name:"values",init:"cell.store = true;",set:"cell.data.values()",idx:-1}),count:i({name:"count",set:"cell.num"}),__count__:i({name:"count",set:"this.missing + this.valid"}),missing:i({name:"missing",set:"this.missing"}),valid:i({name:"valid",set:"this.valid"}),sum:i({name:"sum",init:"this.sum = 0;",add:"this.sum += +v;",rem:"this.sum -= v;",set:"this.sum"}),mean:i({name:"mean",init:"this.mean = 0;",add:"var d = v - this.mean; this.mean += d / this.valid;",rem:"var d = v - this.mean; this.mean -= this.valid ? d / this.valid : this.mean;",set:"this.valid ? this.mean : undefined"}),average:i({name:"average",set:"this.valid ? this.mean : undefined",req:["mean"],idx:1}),variance:i({name:"variance",init:"this.dev = 0;",add:"this.dev += d * (v - this.mean);",rem:"this.dev -= d * (v - this.mean);",set:"this.valid > 1 ? this.dev / (this.valid-1) : undefined",req:["mean"],idx:1}),variancep:i({name:"variancep",set:"this.valid > 1 ? this.dev / this.valid : undefined",req:["variance"],idx:2}),stdev:i({name:"stdev",set:"this.valid > 1 ? Math.sqrt(this.dev / (this.valid-1)) : undefined",req:["variance"],idx:2}),stdevp:i({name:"stdevp",set:"this.valid > 1 ? Math.sqrt(this.dev / this.valid) : undefined",req:["variance"],idx:2}),stderr:i({name:"stderr",set:"this.valid > 1 ? Math.sqrt(this.dev / (this.valid * (this.valid-1))) : undefined",req:["variance"],idx:2}),distinct:i({name:"distinct",set:"cell.data.distinct(this.get)",req:["values"],idx:3}),ci0:i({name:"ci0",set:"cell.data.ci0(this.get)",req:["values"],idx:3}),ci1:i({name:"ci1",set:"cell.data.ci1(this.get)",req:["values"],idx:3}),median:i({name:"median",set:"cell.data.q2(this.get)",req:["values"],idx:3}),q1:i({name:"q1",set:"cell.data.q1(this.get)",req:["values"],idx:3}),q3:i({name:"q3",set:"cell.data.q3(this.get)",req:["values"],idx:3}),argmin:i({name:"argmin",init:"this.argmin = undefined;",add:"if (v < this.min) this.argmin = t;",rem:"if (v <= this.min) this.argmin = undefined;",set:"this.argmin || cell.data.argmin(this.get)",req:["min"],str:["values"],idx:3}),argmax:i({name:"argmax",init:"this.argmax = undefined;",add:"if (v > this.max) this.argmax = t;",rem:"if (v >= this.max) this.argmax = undefined;",set:"this.argmax || cell.data.argmax(this.get)",req:["max"],str:["values"],idx:3}),min:i({name:"min",init:"this.min = undefined;",add:"if (v < this.min || this.min === undefined) this.min = v;",rem:"if (v <= this.min) this.min = NaN;",set:"this.min = (isNaN(this.min) ? cell.data.min(this.get) : this.min)",str:["values"],idx:4}),max:i({name:"max",init:"this.max = undefined;",add:"if (v > this.max || this.max === undefined) this.max = v;",rem:"if (v >= this.max) this.max = NaN;",set:"this.max = (isNaN(this.max) ? cell.data.max(this.get) : this.max)",str:["values"],idx:4})},e=Object.keys(l);function D(t,e){return l[t](e)}function i(i){return function(t){var e=E.extend({init:"",add:"",rem:"",idx:0},i);return e.out=t||i.name,e}}function f(t,e){return t.idx-e.idx}function k(t,e){var i=e||E.identity,n=function(t,a){var e,i=t.reduce(function e(i,t){function n(t){i[t]||e(i,i[t]=l[t]())}return t.req&&t.req.forEach(n),a&&t.str&&t.str.forEach(n),i},t.reduce(function(t,e){return t[e.name]=e,t},{})),n=[];for(e in i)n.push(i[e]);return n.sort(f)}(t,!0),a="var cell = this.cell; this.valid = 0; this.missing = 0;",r="this.cell = cell; this.init();",s="if(v==null){++this.missing; return;} if(v!==v) return; ++this.valid;",u="if(v==null){--this.missing; return;} if(v!==v) return; --this.valid;",o="var cell = this.cell;";return n.forEach(function(t){a+=t.init,s+=t.add,u+=t.rem}),t.slice().sort(f).forEach(function(t){o+="t['"+t.out+"']="+t.set+";"}),o+="return t;",(r=Function("cell",r)).prototype.init=Function(a),r.prototype.add=Function("v","t",s),r.prototype.rem=Function("v","t",u),r.prototype.set=Function("t",o),r.prototype.get=i,r.fields=t.map(function(t){return t.out}),r}function o(t){this._key=t?E.field(t):b.tupleid,this.reset()}var n=o.prototype;function a(t){b.Transform.call(this,null,t),this._adds=[],this._mods=[],this._alen=0,this._mlen=0,this._drop=!0,this._cross=!1,this._dims=[],this._dnames=[],this._measures=[],this._countOnly=!1,this._counts=null,this._prev=null,this._inputs=null,this._outputs=null}n.reset=function(){this._add=[],this._rem=[],this._ext=null,this._get=null,this._q=null},n.add=function(t){this._add.push(t)},n.rem=function(t){this._rem.push(t)},n.values=function(){if(this._get=null,0===this._rem.length)return this._add;var t,e,i,n=this._add,a=this._rem,r=this._key,s=n.length,u=a.length,o=Array(s-u),l={};for(t=0;t<u;++t)l[r(a[t])]=1;for(e=t=0;t<s;++t)l[r(i=n[t])]?l[r(i)]=0:o[e++]=i;return this._rem=[],this._add=o},n.distinct=function(t){for(var e,i=this.values(),n=i.length,a={},r=0;0<=--n;)e=t(i[n])+"",a.hasOwnProperty(e)||(a[e]=1,++r);return r},n.extent=function(t){if(this._get!==t||!this._ext){var e=this.values(),i=E.extentIndex(e,t);this._ext=[e[i[0]],e[i[1]]],this._get=t}return this._ext},n.argmin=function(t){return this.extent(t)[0]||{}},n.argmax=function(t){return this.extent(t)[1]||{}},n.min=function(t){var e=this.extent(t)[0];return null!=e?t(e):void 0},n.max=function(t){var e=this.extent(t)[1];return null!=e?t(e):void 0},n.quartile=function(t){return this._get===t&&this._q||(this._q=m.quartiles(this.values(),t),this._get=t),this._q},n.q1=function(t){return this.quartile(t)[0]},n.q2=function(t){return this.quartile(t)[1]},n.q3=function(t){return this.quartile(t)[2]},n.ci=function(t){return this._get===t&&this._ci||(this._ci=m.bootstrapCI(this.values(),1e3,.05,t),this._get=t),this._ci},n.ci0=function(t){return this.ci(t)[0]},n.ci1=function(t){return this.ci(t)[1]},a.Definition={type:"Aggregate",metadata:{generates:!0,changes:!0},params:[{name:"groupby",type:"field",array:!0},{name:"ops",type:"enum",array:!0,values:e},{name:"fields",type:"field",null:!0,array:!0},{name:"as",type:"string",null:!0,array:!0},{name:"drop",type:"boolean",default:!0},{name:"cross",type:"boolean",default:!1},{name:"key",type:"field"}]};var r=E.inherits(a,b.Transform);function s(t){b.Transform.call(this,null,t)}r.transform=function(t,e){var i,n=this,a=e.fork(e.NO_SOURCE|e.NO_FIELDS);return this.stamp=a.stamp,this.value&&((i=t.modified())||e.modified(this._inputs))?(this._prev=this.value,this.value=i?this.init(t):{},e.visit(e.SOURCE,function(t){n.add(t)})):(this.value=this.value||this.init(t),e.visit(e.REM,function(t){n.rem(t)}),e.visit(e.ADD,function(t){n.add(t)})),a.modifies(this._outputs),n._drop=!1!==t.drop,t.cross&&1<n._dims.length&&(n._drop=!1,this.cross()),n.changes(a)},r.cross=function(){var o=this,l=o.value,f=o._dnames,d=f.map(function(){return{}}),m=f.length;function t(t){var e,i,n,a;for(e in t)for(n=t[e].tuple,i=0;i<m;++i)d[i][a=n[f[i]]]=a}t(o._prev),t(l),function t(e,i,n){var a,r,s=f[n],u=d[n++];for(a in u)i[s]=u[a],r=e?e+"|"+a:a,n<m?t(r,i,n):l[r]||o.cell(r,i)}("",{},0)},r.init=function(t){var r=this._inputs=[],i=this._outputs=[],s={};function n(t){for(var e,i=E.array(E.accessorFields(t)),n=0,a=i.length;n<a;++n)s[e=i[n]]||(s[e]=1,r.push(e))}this._dims=E.array(t.groupby),this._dnames=this._dims.map(function(t){var e=E.accessorName(t);return n(t),i.push(e),e}),this.cellkey=t.key?t.key:v(this._dims),this._countOnly=!0,this._counts=[],this._measures=[];var e,a,u,o,l,f,d=t.fields||[null],m=t.ops||["count"],c=t.as||[],h=d.length,p={};for(h!==m.length&&E.error("Unmatched number of fields and aggregate ops."),f=0;f<h;++f)e=d[f],a=m[f],null==e&&"count"!==a&&E.error("Null aggregate field specified."),l=O(a,o=E.accessorName(e),c[f]),i.push(l),"count"!==a?((u=p[o])||(n(e),(u=p[o]=[]).field=e,this._measures.push(u)),"count"!==a&&(this._countOnly=!1),u.push(D(a,l))):this._counts.push(l);return this._measures=this._measures.map(function(t){return k(t,t.field)}),{}},r.cellkey=v(),r.cell=function(t,e){var i=this.value[t];return i?0===i.num&&this._drop&&i.stamp<this.stamp?(i.stamp=this.stamp,this._adds[this._alen++]=i):i.stamp<this.stamp&&(i.stamp=this.stamp,this._mods[this._mlen++]=i):(i=this.value[t]=this.newcell(t,e),this._adds[this._alen++]=i),i},r.newcell=function(t,e){var i={key:t,num:0,agg:null,tuple:this.newtuple(e,this._prev&&this._prev[t]),stamp:this.stamp,store:!1};if(!this._countOnly){var n,a=this._measures,r=a.length;for(i.agg=Array(r),n=0;n<r;++n)i.agg[n]=new a[n](i)}return i.store&&(i.data=new o),i},r.newtuple=function(t,e){var i,n,a=this._dnames,r=this._dims,s={};for(i=0,n=r.length;i<n;++i)s[a[i]]=r[i](t);return e?b.replace(e.tuple,s):b.ingest(s)},r.add=function(t){var e,i,n,a=this.cellkey(t),r=this.cell(a,t);if(r.num+=1,!this._countOnly)for(r.store&&r.data.add(t),i=0,n=(e=r.agg).length;i<n;++i)e[i].add(e[i].get(t),t)},r.rem=function(t){var e,i,n,a=this.cellkey(t),r=this.cell(a,t);if(r.num-=1,!this._countOnly)for(r.store&&r.data.rem(t),i=0,n=(e=r.agg).length;i<n;++i)e[i].rem(e[i].get(t),t)},r.celltuple=function(t){var e,i,n,a=t.tuple,r=this._counts;for(t.store&&t.data.values(),i=0,n=r.length;i<n;++i)a[r[i]]=t.num;if(!this._countOnly)for(i=0,n=(e=t.agg).length;i<n;++i)e[i].set(a);return a},r.changes=function(t){var e,i,n,a,r=this._adds,s=this._mods,u=this._prev,o=this._drop,l=t.add,f=t.rem,d=t.mod;if(u)for(i in u)e=u[i],o&&!e.num||f.push(e.tuple);for(n=0,a=this._alen;n<a;++n)l.push(this.celltuple(r[n])),r[n]=null;for(n=0,a=this._mlen;n<a;++n)(0===(e=s[n]).num&&o?f:d).push(this.celltuple(e)),s[n]=null;return this._alen=this._mlen=0,this._prev=null,t},s.Definition={type:"Bin",metadata:{modifies:!0},params:[{name:"field",type:"field",required:!0},{name:"anchor",type:"number"},{name:"maxbins",type:"number",default:20},{name:"base",type:"number",default:10},{name:"divide",type:"number",array:!0,default:[5,2]},{name:"extent",type:"number",array:!0,length:2,required:!0},{name:"step",type:"number"},{name:"steps",type:"number",array:!0},{name:"minstep",type:"number",default:0},{name:"nice",type:"boolean",default:!0},{name:"name",type:"string"},{name:"as",type:"string",array:!0,length:2,default:["bin0","bin1"]}]};var u=E.inherits(s,b.Transform);function c(t,e,i){var n=t,a=e||[],r=i||[],s={},u=0;return{add:function(t){r.push(t)},remove:function(t){s[n(t)]=++u},size:function(){return a.length},data:function(t,e){return u&&(a=a.filter(function(t){return!s[n(t)]}),s={},u=0),e&&t&&a.sort(t),r.length&&(a=t?E.merge(t,a,r.sort(t)):a.concat(r),r=[]),a}}}function h(t){b.Transform.call(this,[],t)}function p(t){b.Operator.call(this,null,g,t)}function g(t){return this.value&&!t.modified()?this.value:E.compare(t.fields,t.orders)}function y(t){b.Transform.call(this,null,t)}u.transform=function(t,e){var i,n=this._bins(t),a=n.start,r=n.step,s=t.as||["bin0","bin1"],u=s[0],o=s[1];return i=t.modified()?(e=e.reflow(!0)).SOURCE:e.modified(E.accessorFields(t.field))?e.ADD_MOD:e.ADD,e.visit(i,function(t){var e=n(t);t[u]=e,t[o]=null==e?null:a+r*(1+(e-a)/r)}),e.modifies(s)},u._bins=function(t){if(this.value&&!t.modified())return this.value;var e,i,n=t.field,a=m.bin(t),r=a.start,s=a.stop,u=a.step;null!=(e=t.anchor)&&(i=e-(r+u*Math.floor((e-r)/u)),r+=i,s+=i);var o=function(t){var e=n(t);return null==e?null:(e=Math.max(r,Math.min(+e,s-u)),r+u*Math.floor((e-r)/u))};return o.start=r,o.stop=s,o.step=u,this.value=E.accessor(o,E.accessorFields(n),t.name||"bin_"+E.accessorName(n))},h.Definition={type:"Collect",metadata:{source:!0},params:[{name:"sort",type:"compare"}]},E.inherits(h,b.Transform).transform=function(t,e){var i=e.fork(e.ALL),n=c(b.tupleid,this.value,i.materialize(i.ADD).add),a=t.sort,r=e.changed()||a&&(t.modified("sort")||e.modified(a.fields));return i.visit(i.REM,n.remove),this.modified(r),this.value=i.source=n.data(a,r),e.source&&e.source.root&&(this.value.root=e.source.root),i},E.inherits(p,b.Operator),y.Definition={type:"CountPattern",metadata:{generates:!0,changes:!0},params:[{name:"field",type:"field",required:!0},{name:"case",type:"enum",values:["upper","lower","mixed"],default:"mixed"},{name:"pattern",type:"string",default:'[\\w"]+'},{name:"stopwords",type:"string",default:""},{name:"as",type:"string",array:!0,length:2,default:["text","count"]}]};var _=E.inherits(y,b.Transform);function x(t){b.Transform.call(this,null,t)}_.transform=function(s,t){function e(r){return function(t){for(var e,i=function(t,e,i){switch(e){case"upper":t=t.toUpperCase();break;case"lower":t=t.toLowerCase()}return t.match(i)}(l(t),s.case,u)||[],n=0,a=i.length;n<a;++n)o.test(e=i[n])||r(e)}}var i=this._parameterCheck(s,t),n=this._counts,u=this._match,o=this._stop,l=s.field,a=s.as||["text","count"],r=e(function(t){n[t]=1+(n[t]||0)}),f=e(function(t){n[t]-=1});return i?t.visit(t.SOURCE,r):(t.visit(t.ADD,r),t.visit(t.REM,f)),this._finish(t,a)},_._parameterCheck=function(t,e){var i=!1;return!t.modified("stopwords")&&this._stop||(this._stop=new RegExp("^"+(t.stopwords||"")+"$","i"),i=!0),!t.modified("pattern")&&this._match||(this._match=new RegExp(t.pattern||"[\\w']+","g"),i=!0),(t.modified("field")||e.modified(t.field.fields))&&(i=!0),i&&(this._counts={}),i},_._finish=function(t,e){var i,n,a,r=this._counts,s=this._tuples||(this._tuples={}),u=e[0],o=e[1],l=t.fork(t.NO_SOURCE|t.NO_FIELDS);for(i in r)n=s[i],a=r[i]||0,!n&&a?(s[i]=n=b.ingest({}),n[u]=i,n[o]=a,l.add.push(n)):0===a?(n&&l.rem.push(n),r[i]=null,s[i]=null):n[o]!==a&&(n[o]=a,l.mod.push(n));return l.modifies(e)},x.Definition={type:"Cross",metadata:{generates:!0},params:[{name:"filter",type:"expr"},{name:"as",type:"string",array:!0,length:2,default:["a","b"]}]},E.inherits(x,b.Transform).transform=function(t,e){var i=e.fork(e.NO_SOURCE),n=this.value,a=t.as||["a","b"],r=a[0],s=a[1];return!n||e.changed(e.ADD_REM)||t.modified("as")||t.modified("filter")?(n&&(i.rem=n),n=e.materialize(e.SOURCE).source,i.add=this.value=function(t,e,i,n){for(var a,r,s=[],u={},o=t.length,l=0;l<o;++l)for(u[e]=r=t[l],a=0;a<o;++a)u[i]=t[a],n(u)&&(s.push(b.ingest(u)),(u={})[e]=r);return s}(n,r,s,t.filter||E.truthy)):i.mod=n,i.source=this.value,i.modifies(a)};var q={kde:m.randomKDE,mixture:m.randomMixture,normal:m.randomNormal,uniform:m.randomUniform},w="distributions",T="function",N="field";function R(t){b.Transform.call(this,null,t)}var M=[{key:{function:"normal"},params:[{name:"mean",type:"number",default:0},{name:"stdev",type:"number",default:1}]},{key:{function:"uniform"},params:[{name:"min",type:"number",default:0},{name:"max",type:"number",default:1}]},{key:{function:"kde"},params:[{name:"field",type:"field",required:!0},{name:"from",type:"data"},{name:"bandwidth",type:"number",default:0}]}],S={key:{function:"mixture"},params:[{name:"distributions",type:"param",array:!0,params:M},{name:"weights",type:"number",array:!0}]};function C(t){b.Operator.call(this,null,A,t),this.modified(!0)}function A(e){var i=e.expr;return this.value&&!e.modified("expr")?this.value:E.accessor(function(t){return i(t,e)},E.accessorFields(i),E.accessorName(i))}function U(t){b.Transform.call(this,[void 0,void 0],t)}function F(t,e){b.Operator.call(this,t),this.parent=e}R.Definition={type:"Density",metadata:{generates:!0},params:[{name:"extent",type:"number",array:!0,length:2},{name:"steps",type:"number",default:100},{name:"method",type:"string",default:"pdf",values:["pdf","cdf"]},{name:"distribution",type:"param",params:M.concat(S)},{name:"as",type:"string",array:!0,default:["value","density"]}]},E.inherits(R,b.Transform).transform=function(t,e){var i,n=e.fork(e.NO_SOURCE|e.NO_FIELDS);if(!this.value||e.changed()||t.modified()){var a=function e(t,i){var n=t[T];q.hasOwnProperty(n)||E.error("Unknown distribution function: "+n);var a=q[n]();for(var r in t)r===N?a.data((t.from||i()).map(t[r])):r===w?a[r](t[r].map(function(t){return e(t,i)})):typeof a[r]===T&&a[r](t[r]);return a}(t.distribution,(i=e,function(){return i.materialize(i.SOURCE).source})),r=t.method||"pdf";"pdf"!==r&&"cdf"!==r&&E.error("Invalid density method: "+r),t.extent||a.data||E.error("Missing density extent parameter."),r=a[r];var s=t.as||["value","density"],u=t.extent||d.extent(a.data()),o=(u[1]-u[0])/(t.steps||100),l=d.range(u[0],u[1]+o/2,o).map(function(t){var e={};return e[s[0]]=t,e[s[1]]=r(t),b.ingest(e)});this.value&&(n.rem=this.value),this.value=n.add=n.source=l}return n},E.inherits(C,b.Operator),U.Definition={type:"Extent",metadata:{},params:[{name:"field",type:"field",required:!0}]},E.inherits(U,b.Transform).transform=function(t,e){var i,n=this.value,a=t.field,r=n[0],s=n[1];((i=e.changed()||e.modified(a.fields)||t.modified("field"))||null==r)&&(r=1/0,s=-1/0),e.visit(i?e.SOURCE:e.ADD,function(t){var e=a(t);null!=e&&((e=+e)<r&&(r=e),s<e&&(s=e))}),isFinite(r)&&isFinite(s)||(r=s=void 0),this.value=[r,s]};var z=E.inherits(F,b.Operator);function L(t){b.Transform.call(this,{},t),this._keys=E.fastmap();var n=this._targets=[];n.active=0,n.forEach=function(t){for(var e=0,i=n.active;e<i;++e)t(n[e],e,n)}}z.connect=function(t){return this.targets().add(t),t.source=this},z.add=function(t){this.value.add.push(t)},z.rem=function(t){this.value.rem.push(t)},z.mod=function(t){this.value.mod.push(t)},z.init=function(t){this.value.init(t,t.NO_SOURCE)},z.evaluate=function(){return this.value};var P=E.inherits(L,b.Transform);function I(t){b.Operator.call(this,null,j,t)}function j(t){return this.value&&!t.modified()?this.value:E.isArray(t.name)?E.array(t.name).map(function(t){return E.field(t)}):E.field(t.name,t.as)}function W(t){b.Transform.call(this,E.fastmap(),t)}function B(t,i){return t?t.map(function(t,e){return i[e]||E.accessorName(t)}):null}function J(t){b.Transform.call(this,[],t)}function K(t){b.Transform.call(this,[],t)}function $(t){b.Transform.call(this,null,t)}function G(t){b.Transform.call(this,[],t)}P.activate=function(t){this._targets[this._targets.active++]=t},P.subflow=function(t,e,i,n){var a,r,s=this.value,u=s.hasOwnProperty(t)&&s[t];return u?u.value.stamp<i.stamp&&(u.init(i),this.activate(u)):(r=n||(r=this._group[t])&&r.tuple,u=(a=i.dataflow).add(new F(i.fork(i.NO_SOURCE),this)).connect(e(a,t,r)),s[t]=u,this.activate(u)),u},P.transform=function(t,e){var i=e.dataflow,n=this,a=t.key,r=t.subflow,s=this._keys,u=t.modified("key");function o(t){return n.subflow(t,r,e)}return this._group=t.group||{},this._targets.active=0,e.visit(e.REM,function(t){var e=b.tupleid(t),i=s.get(e);void 0!==i&&(s.delete(e),o(i).rem(t))}),e.visit(e.ADD,function(t){var e=a(t);s.set(b.tupleid(t),e),o(e).add(t)}),u||e.modified(a.fields)?e.visit(e.MOD,function(t){var e=b.tupleid(t),i=s.get(e),n=a(t);i===n?o(n).mod(t):(s.set(e,n),o(i).rem(t),o(n).add(t))}):e.changed(e.MOD)&&e.visit(e.MOD,function(t){o(s.get(b.tupleid(t))).mod(t)}),u&&e.visit(e.REFLOW,function(t){var e=b.tupleid(t),i=s.get(e),n=a(t);i!==n&&(s.set(e,n),o(i).rem(t),o(n).add(t))}),s.empty>i.cleanThreshold&&i.runAfter(s.clean),e},E.inherits(I,b.Operator),W.Definition={type:"Filter",metadata:{changes:!0},params:[{name:"expr",type:"expr",required:!0}]},E.inherits(W,b.Transform).transform=function(a,t){var e=t.dataflow,r=this.value,i=t.fork(),s=i.add,u=i.rem,o=i.mod,l=a.expr,f=!0;function n(t){var e=b.tupleid(t),i=l(t,a),n=r.get(e);i&&n?(r.delete(e),s.push(t)):i||n?f&&i&&!n&&o.push(t):(r.set(e,1),u.push(t))}return t.visit(t.REM,function(t){var e=b.tupleid(t);r.has(e)?r.delete(e):u.push(t)}),t.visit(t.ADD,function(t){l(t,a)?s.push(t):r.set(b.tupleid(t),1)}),t.visit(t.MOD,n),a.modified()&&(f=!1,t.visit(t.REFLOW,n)),r.empty>e.cleanThreshold&&e.runAfter(r.clean),i},J.Definition={type:"Flatten",metadata:{generates:!0},params:[{name:"fields",type:"field",array:!0,required:!0},{name:"as",type:"string",array:!0}]},E.inherits(J,b.Transform).transform=function(t,e){var u=e.fork(e.NO_SOURCE),o=t.fields,l=B(o,t.as||[]),f=l.length;return u.rem=this.value,e.visit(e.SOURCE,function(e){for(var t,i,n,a=o.map(function(t){return t(e)}),r=a.reduce(function(t,e){return Math.max(t,e.length)},0),s=0;s<r;++s){for(i=b.derive(e),t=0;t<f;++t)i[l[t]]=null==(n=a[t][s])?null:n;u.add.push(i)}}),this.value=u.source=u.add,u.modifies(l)},K.Definition={type:"Fold",metadata:{generates:!0},params:[{name:"fields",type:"field",array:!0,required:!0},{name:"as",type:"string",array:!0,length:2,default:["key","value"]}]},E.inherits(K,b.Transform).transform=function(t,e){var n=e.fork(e.NO_SOURCE),a=t.fields,r=a.map(E.accessorName),i=t.as||["key","value"],s=i[0],u=i[1],o=a.length;return n.rem=this.value,e.visit(e.SOURCE,function(t){for(var e,i=0;i<o;++i)(e=b.derive(t))[s]=r[i],e[u]=a[i](t),n.add.push(e)}),this.value=n.source=n.add,n.modifies(i)},$.Definition={type:"Formula",metadata:{modifies:!0},params:[{name:"expr",type:"expr",required:!0},{name:"as",type:"string",required:!0},{name:"initonly",type:"boolean"}]},E.inherits($,b.Transform).transform=function(e,t){var i=e.expr,n=e.as,a=e.modified(),r=e.initonly?t.ADD:a?t.SOURCE:t.modified(i.fields)?t.ADD_MOD:t.ADD;return a&&(t=t.materialize().reflow(!0)),e.initonly||t.modifies(n),t.visit(r,function(t){t[n]=i(t,e)})},E.inherits(G,b.Transform).transform=function(t,e){var i,n,a,r=this.value,s=e.fork(e.ALL),u=t.size-r.length,o=t.generator;if(0<u){for(i=[];0<=--u;)i.push(a=b.ingest(o(t))),r.push(a);s.add=s.add.length?s.materialize(s.ADD).add.concat(i):i}else n=r.slice(0,-u),s.rem=s.rem.length?s.materialize(s.REM).rem.concat(n):n,r=r.slice(-u);return s.source=this.value=r,s};var H={value:"value",median:d.median,mean:d.mean,min:d.min,max:d.max},Q=[];function V(t){b.Transform.call(this,[],t)}function X(t){a.call(this,t)}V.Definition={type:"Impute",metadata:{changes:!0},params:[{name:"field",type:"field",required:!0},{name:"key",type:"field",required:!0},{name:"keyvals",array:!0},{name:"groupby",type:"field",array:!0},{name:"method",type:"enum",default:"value",values:["value","mean","median","max","min"]},{name:"value",default:0}]},E.inherits(V,b.Transform).transform=function(t,e){var i,n,a,r,s,u,o,l,f,d,m,c=e.fork(e.ALL),h=function(t){var e,i=t.method||H.value;if(null!=H[i])return i===H.value?(e=void 0!==t.value?t.value:0,function(){return e}):H[i];E.error("Unrecognized imputation method: "+i)}(t),p=(m=t.field,function(t){return t?m(t):NaN}),v=E.accessorName(t.field),g=E.accessorName(t.key),y=(t.groupby||[]).map(E.accessorName),_=function(t,e,i,n){var a,r,s,u,o,l,f,d,m=function(t){return t(d)},c=[],h=n?n.slice():[],p={},v={};for(h.forEach(function(t,e){p[t]=e+1}),u=0,f=t.length;u<f;++u)d=t[u],l=i(d),o=p[l]||(p[l]=h.push(l)),r=(a=e?e.map(m):Q)+"",(s=v[r])||(s=v[r]=[],c.push(s),s.values=a),s[o-1]=d;return c.domain=h,c}(e.source,t.groupby,t.key,t.keyvals),x=[],O=this.value,D=_.domain.length;for(s=0,l=_.length;s<l;++s)for(a=(i=_[s]).values,n=NaN,o=0;o<D;++o)if(null==i[o]){for(r=_.domain[o],d={_impute:!0},u=0,f=a.length;u<f;++u)d[y[u]]=a[u];d[g]=r,d[v]=isNaN(n)?n=h(i,p):n,x.push(b.ingest(d))}return x.length&&(c.add=c.materialize(c.ADD).add.concat(x)),O.length&&(c.rem=c.materialize(c.REM).rem.concat(O)),this.value=x,c},X.Definition={type:"JoinAggregate",metadata:{modifies:!0},params:[{name:"groupby",type:"field",array:!0},{name:"fields",type:"field",null:!0,array:!0},{name:"ops",type:"enum",array:!0,values:e},{name:"as",type:"string",null:!0,array:!0},{name:"key",type:"field"}]};var Y=E.inherits(X,a);function Z(t){b.Operator.call(this,null,tt,t)}function tt(t){return this.value&&!t.modified()?this.value:E.key(t.fields,t.flat)}function et(t){b.Transform.call(this,null,t)}function it(t){b.Transform.call(this,{},t)}function nt(t){b.Operator.call(this,null,at,t)}function at(t){if(this.value&&!t.modified())return this.value;var e,i,n,a=1/0,r=-1/0,s=t.extents;for(e=0,i=s.length;e<i;++e)(n=s[e])[0]<a&&(a=n[0]),n[1]>r&&(r=n[1]);return[a,r]}function rt(t){b.Operator.call(this,null,st,t)}function st(t){return this.value&&!t.modified()?this.value:t.values.reduce(function(t,e){return t.concat(e)},[])}function ut(t){b.Transform.call(this,null,t)}function ot(t){a.call(this,t)}Y.transform=function(t,e){var i,n=this,a=t.modified();return n.value&&(a||e.modified(n._inputs))?(i=n.value=a?n.init(t):{},e.visit(e.SOURCE,function(t){n.add(t)})):(i=n.value=n.value||this.init(t),e.visit(e.REM,function(t){n.rem(t)}),e.visit(e.ADD,function(t){n.add(t)})),n.changes(),e.visit(e.SOURCE,function(t){E.extend(t,i[n.cellkey(t)].tuple)}),e.reflow(a).modifies(this._outputs)},Y.changes=function(){var t,e,i=this._adds,n=this._mods;for(t=0,e=this._alen;t<e;++t)this.celltuple(i[t]),i[t]=null;for(t=0,e=this._mlen;t<e;++t)this.celltuple(n[t]),n[t]=null;this._alen=this._mlen=0},E.inherits(Z,b.Operator),E.inherits(et,b.Transform).transform=function(t,e){e.dataflow.request(this.target,t.url,t.format)},it.Definition={type:"Lookup",metadata:{modifies:!0},params:[{name:"index",type:"index",params:[{name:"from",type:"data",required:!0},{name:"key",type:"field",required:!0}]},{name:"values",type:"field",array:!0},{name:"fields",type:"field",array:!0,required:!0},{name:"as",type:"string",array:!0},{name:"default",default:null}]},E.inherits(it,b.Transform).transform=function(t,e){var i,r,n=e,s=t.as,u=t.fields,o=t.index,l=t.values,f=null==t.default?null:t.default,a=t.modified(),d=a?e.SOURCE:e.ADD,m=u.length;return i=l?(r=l.length,1<m&&!s&&E.error('Multi-field lookup requires explicit "as" parameter.'),s&&s.length!==m*r&&E.error('The "as" parameter has too few output field names.'),s=s||l.map(E.accessorName),function(t){for(var e,i,n=0,a=0;n<m;++n)if(null==(i=o.get(u[n](t))))for(e=0;e<r;++e,++a)t[s[a]]=f;else for(e=0;e<r;++e,++a)t[s[a]]=l[e](i)}):(s||E.error("Missing output field names."),function(t){for(var e,i=0;i<m;++i)e=o.get(u[i](t)),t[s[i]]=null==e?f:e}),a?n=e.reflow(!0):d|=u.some(function(t){return e.modified(t.fields)})?e.MOD:0,e.visit(d,i),n.modifies(s)},E.inherits(nt,b.Operator),E.inherits(rt,b.Operator),E.inherits(ut,b.Transform),ut.prototype.transform=function(t,e){return this.modified(t.modified()),this.value=t,e.fork(e.NO_SOURCE|e.NO_FIELDS)},ot.Definition={type:"Pivot",metadata:{generates:!0,changes:!0},params:[{name:"groupby",type:"field",array:!0},{name:"field",type:"field",required:!0},{name:"value",type:"field",required:!0},{name:"op",type:"enum",values:e,default:"sum"},{name:"limit",type:"number",default:0},{name:"key",type:"field"}]};var lt=E.inherits(ot,a);function ft(t){L.call(this,t)}function dt(t){b.Transform.call(this,null,t)}function mt(t){b.Transform.call(this,null,t)}function ct(t){b.Transform.call(this,null,t)}function ht(t){b.Transform.call(this,[],t),this.count=0}function pt(t){b.Transform.call(this,null,t)}function vt(t){b.Transform.call(this,null,t),this.modified(!0)}function gt(t){b.Transform.call(this,E.fastmap(),t)}function yt(t){b.Transform.call(this,null,t)}lt._transform=lt.transform,lt.transform=function(t,e){return this._transform((n=e,r=(i=t).field,s=i.value,a=("count"===i.op?"__count__":i.op)||"sum",u=E.accessorFields(r).concat(E.accessorFields(s)),l=r,f=i.limit||0,m={},c=[],(d=n).visit(d.SOURCE,function(t){var e=l(t);m[e]||(m[e]=1,c.push(e))}),c.sort(function(t,e){return(t<e||null==t)&&null!=e?-1:(e<t||null==e)&&null!=t?1:(e=e instanceof Date?+e:e,(t=t instanceof Date?+t:t)!==t&&e==e?-1:e!=e&&t==t?1:0)}),o=f?c.slice(0,f):c,{key:i.key,groupby:i.groupby,ops:o.map(function(){return a}),fields:o.map(function(t){return e=t,i=r,n=s,a=u,E.accessor(function(t){return i(t)===e?n(t):NaN},a,e+"");var e,i,n,a}),as:o.map(function(t){return t+""}),modified:i.modified.bind(i)}),e);var i,n,r,s,a,u,o,l,f,d,m,c},E.inherits(ft,L).transform=function(t,i){var n=this,a=t.subflow,r=t.field;return(t.modified("field")||r&&i.modified(E.accessorFields(r)))&&E.error("PreFacet does not support field modification."),this._targets.active=0,i.visit(i.MOD,function(t){var e=n.subflow(b.tupleid(t),a,i,t);r?r(t).forEach(function(t){e.mod(t)}):e.mod(t)}),i.visit(i.ADD,function(t){var e=n.subflow(b.tupleid(t),a,i,t);r?r(t).forEach(function(t){e.add(b.ingest(t))}):e.add(t)}),i.visit(i.REM,function(t){var e=n.subflow(b.tupleid(t),a,i,t);r?r(t).forEach(function(t){e.rem(t)}):e.rem(t)}),i},dt.Definition={type:"Project",metadata:{generates:!0,changes:!0},params:[{name:"fields",type:"field",array:!0},{name:"as",type:"string",null:!0,array:!0}]},E.inherits(dt,b.Transform).transform=function(t,e){var i,n,a=t.fields,r=B(t.fields,t.as||[]),s=a?function(t,e){return function(t,e,i,n){for(var a=0,r=i.length;a<r;++a)e[n[a]]=i[a](t);return e}(t,e,a,r)}:b.rederive;return n=this.value?this.value:(e=e.addAll(),this.value={}),i=e.fork(e.NO_SOURCE),e.visit(e.REM,function(t){var e=b.tupleid(t);i.rem.push(n[e]),n[e]=null}),e.visit(e.ADD,function(t){var e=s(t,b.ingest({}));n[b.tupleid(t)]=e,i.add.push(e)}),e.visit(e.MOD,function(t){i.mod.push(s(t,n[b.tupleid(t)]))}),i},E.inherits(mt,b.Transform).transform=function(t,e){return this.value=t.value,t.modified("value")?e.fork(e.NO_SOURCE|e.NO_FIELDS):e.StopPropagation},E.inherits(ct,b.Transform).transform=function(t,e){var i,n;return n=this.value?this.value:(i=e=e.addAll(),this.value={}),t.derive&&(i=e.fork(e.NO_SOURCE),e.visit(e.REM,function(t){var e=b.tupleid(t);i.rem.push(n[e]),n[e]=null}),e.visit(e.ADD,function(t){var e=b.derive(t);n[b.tupleid(t)]=e,i.add.push(e)}),e.visit(e.MOD,function(t){i.mod.push(b.rederive(t,n[b.tupleid(t)]))})),i},ht.Definition={type:"Sample",metadata:{},params:[{name:"size",type:"number",default:1e3}]},E.inherits(ht,b.Transform).transform=function(t,e){var n=e.fork(e.NO_SOURCE),i=t.modified("size"),a=t.size,r=this.value,s=this.count,u=0,o=r.reduce(function(t,e){return t[b.tupleid(e)]=1,t},{});function l(t){var e,i;r.length<a?r.push(t):(i=~~((s+1)*m.random()))<r.length&&u<=i&&(e=r[i],o[b.tupleid(e)]&&n.rem.push(e),r[i]=t),++s}if(e.rem.length&&(e.visit(e.REM,function(t){var e=b.tupleid(t);o[e]&&(o[e]=-1,n.rem.push(t)),--s}),r=r.filter(function(t){return-1!==o[b.tupleid(t)]})),(e.rem.length||i)&&r.length<a&&e.source&&(u=s=r.length,e.visit(e.SOURCE,function(t){o[b.tupleid(t)]||l(t)}),u=-1),i&&r.length>a){for(var f=0,d=r.length-a;f<d;++f)o[b.tupleid(r[f])]=-1,n.rem.push(r[f]);r=r.slice(d)}return e.mod.length&&e.visit(e.MOD,function(t){o[b.tupleid(t)]&&n.mod.push(t)}),e.add.length&&e.visit(e.ADD,l),(e.add.length||u<0)&&(n.add=r.filter(function(t){return!o[b.tupleid(t)]})),this.count=s,this.value=n.source=r,n},pt.Definition={type:"Sequence",metadata:{changes:!0},params:[{name:"start",type:"number",required:!0},{name:"stop",type:"number",required:!0},{name:"step",type:"number",default:1},{name:"as",type:"string",default:"data"}]},E.inherits(pt,b.Transform).transform=function(t,e){if(!this.value||t.modified()){var i=e.materialize().fork(e.MOD),n=t.as||"data";return i.rem=this.value?e.rem.concat(this.value):e.rem,this.value=d.range(t.start,t.stop,t.step||1).map(function(t){var e={};return e[n]=t,b.ingest(e)}),i.add=e.add.concat(this.value),i}},E.inherits(vt,b.Transform).transform=function(t,e){return this.value=e.source,e.changed()?e.fork(e.NO_SOURCE|e.NO_FIELDS):e.StopPropagation},E.inherits(gt,b.Transform).transform=function(t,e){var i=e.dataflow,n=t.field,a=this.value,r=!0;function s(t){a.set(n(t),t)}return t.modified("field")||e.modified(n.fields)?(a.clear(),e.visit(e.SOURCE,s)):e.changed()?(e.visit(e.REM,function(t){a.delete(n(t))}),e.visit(e.ADD,s)):r=!1,this.modified(r),a.empty>i.cleanThreshold&&i.runAfter(a.clean),e.fork()},E.inherits(yt,b.Transform).transform=function(t,e){(!this.value||t.modified("field")||t.modified("sort")||e.changed()||t.sort&&e.modified(t.sort.fields))&&(this.value=(t.sort?e.source.slice().sort(t.sort):e.source).map(t.field))};var _t={row_number:function(){return{next:function(t){return t.index+1}}},rank:function(){var n;return{init:function(){n=1},next:function(t){var e=t.index,i=t.data;return e&&t.compare(i[e-1],i[e])?n=e+1:n}}},dense_rank:function(){var n;return{init:function(){n=1},next:function(t){var e=t.index,i=t.data;return e&&t.compare(i[e-1],i[e])?++n:n}}},percent_rank:function(){var t=_t.rank(),e=t.next;return{init:t.init,next:function(t){return(e(t)-1)/(t.data.length-1)}}},cume_dist:function(){var a;return{init:function(){a=0},next:function(t){var e=t.index,i=t.data,n=t.compare;if(a<e){for(;e+1<i.length&&!n(i[e],i[e+1]);)++e;a=e}return(1+a)/i.length}}},ntile:function(t,e){0<(e=+e)||E.error("ntile num must be greater than zero.");var i=_t.cume_dist(),n=i.next;return{init:i.init,next:function(t){return Math.ceil(e*n(t))}}},lag:function(i,n){return n=+n||1,{next:function(t){var e=t.index-n;return 0<=e?i(t.data[e]):null}}},lead:function(n,a){return a=+a||1,{next:function(t){var e=t.index+a,i=t.data;return e<i.length?n(i[e]):null}}},first_value:function(e){return{next:function(t){return e(t.data[t.i0])}}},last_value:function(e){return{next:function(t){return e(t.data[t.i1-1])}}},nth_value:function(i,n){return 0<(n=+n)||E.error("nth_value nth must be greater than zero."),{next:function(t){var e=t.i0+(n-1);return e<t.i1?i(t.data[e]):null}}}},xt=Object.keys(_t);function Ot(t){var e=E.array(t.ops),d=E.array(t.fields),m=E.array(t.params),c=E.array(t.as),h=this.outputs=[],p=this.windows=[],i={},v={},g=!0,y=[],_=[];function x(t){E.array(E.accessorFields(t)).forEach(function(t){i[t]=1})}x(t.sort),e.forEach(function(t,e){var i,n,a,r,s,u=d[e],o=E.accessorName(u),l=O(t,o,c[e]);if(x(u),h.push(l),_t.hasOwnProperty(t))p.push((i=t,n=d[e],a=m[e],r=l,{init:(s=_t[i](n,a)).init||E.zero,update:function(t,e){e[r]=s.next(t)}}));else{if(null==u&&"count"!==t&&E.error("Null aggregate field specified."),"count"===t)return void y.push(l);g=!1;var f=v[o];f||((f=v[o]=[]).field=u,_.push(f)),f.push(D(t,l))}}),(y.length||_.length)&&(this.cell=function(t,n,a){t=t.map(function(t){return k(t,t.field)});var r={num:0,agg:null,store:!1,count:n};if(!a)for(var i=t.length,s=r.agg=Array(i),e=0;e<i;++e)s[e]=new t[e](r);if(r.store)var u=r.data=new o;return r.add=function(t){if(r.num+=1,!a){u&&u.add(t);for(var e=0;e<i;++e)s[e].add(s[e].get(t),t)}},r.rem=function(t){if(r.num-=1,!a){u&&u.rem(t);for(var e=0;e<i;++e)s[e].rem(s[e].get(t),t)}},r.set=function(t){var e,i;for(u&&u.values(),e=0,i=n.length;e<i;++e)t[n[e]]=r.num;if(!a)for(e=0,i=s.length;e<i;++e)s[e].set(t)},r.init=function(){r.num=0,u&&u.reset();for(var t=0;t<i;++t)s[t].init()},r}(_,y,g)),this.inputs=Object.keys(i)}var Dt=Ot.prototype;function bt(t){b.Transform.call(this,{},t),this._mlen=0,this._mods=[]}Dt.init=function(){this.windows.forEach(function(t){t.init()}),this.cell&&this.cell.init()},Dt.update=function(t,e){var i,n=this.cell,a=this.windows,r=t.data,s=a&&a.length;if(n){for(i=t.p0;i<t.i0;++i)n.rem(r[i]);for(i=t.p1;i<t.i1;++i)n.add(r[i]);n.set(e)}for(i=0;i<s;++i)a[i].update(t,e)},bt.Definition={type:"Window",metadata:{modifies:!0},params:[{name:"sort",type:"compare"},{name:"groupby",type:"field",array:!0},{name:"ops",type:"enum",array:!0,values:xt.concat(e)},{name:"params",type:"number",null:!0,array:!0},{name:"fields",type:"field",null:!0,array:!0},{name:"as",type:"string",null:!0,array:!0},{name:"frame",type:"number",null:!0,array:!0,length:2,default:[null,0]},{name:"ignorePeers",type:"boolean",default:!1}]};var Et=E.inherits(bt,b.Transform);function kt(t,e,i){var n=i.sort,a=n&&!i.ignorePeers,r=i.frame||[null,0],s=t.data(n),u=s.length,o=0,l=a?d.bisector(n):null,f={i0:0,i1:0,p0:0,p1:0,index:0,data:s,compare:n||E.constant(-1)};for(e.init();o<u;++o)qt(f,r,o,u),a&&wt(f,l),e.update(f,s[o])}function qt(t,e,i,n){t.p0=t.i0,t.p1=t.i1,t.i0=null==e[0]?0:Math.max(0,i-Math.abs(e[0])),t.i1=null==e[1]?n:Math.min(n,i+Math.abs(e[1])+1),t.index=i}function wt(t,e){var i=t.i0,n=t.i1-1,a=t.compare,r=t.data,s=r.length-1;0<i&&!a(r[i],r[i-1])&&(t.i0=e.left(r,r[i])),n<s&&!a(r[n],r[n+1])&&(t.i1=e.right(r,r[n]))}Et.transform=function(t,e){var i,n,a=this,r=a.state,s=t.modified();this.stamp=e.stamp,r&&!s||(r=a.state=new Ot(t));var u=v(t.groupby);function o(t){return a.group(u(t))}for(s||e.modified(r.inputs)?(a.value={},e.visit(e.SOURCE,function(t){o(t).add(t)})):(e.visit(e.REM,function(t){o(t).remove(t)}),e.visit(e.ADD,function(t){o(t).add(t)})),i=0,n=a._mlen;i<n;++i)kt(a._mods[i],r,t);return a._mlen=0,a._mods=[],e.reflow(s).modifies(r.outputs)},Et.group=function(t){var e=this,i=e.value[t];return i||((i=e.value[t]=c(b.tupleid)).stamp=-1),i.stamp<e.stamp&&(i.stamp=e.stamp,e._mods[e._mlen++]=i),i},t.aggregate=a,t.bin=s,t.collect=h,t.compare=p,t.countpattern=y,t.cross=x,t.density=R,t.expression=C,t.extent=U,t.facet=L,t.field=I,t.filter=W,t.flatten=J,t.fold=K,t.formula=$,t.generate=G,t.impute=V,t.joinaggregate=X,t.key=Z,t.load=et,t.lookup=it,t.multiextent=nt,t.multivalues=rt,t.params=ut,t.pivot=ot,t.prefacet=ft,t.project=dt,t.proxy=mt,t.relay=ct,t.sample=ht,t.sequence=pt,t.sieve=vt,t.subflow=F,t.tupleindex=gt,t.values=yt,t.window=bt,Object.defineProperty(t,"__esModule",{value:!0})});