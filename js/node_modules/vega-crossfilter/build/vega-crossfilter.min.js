!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?r(exports,require("d3-array"),require("vega-dataflow"),require("vega-util")):"function"==typeof define&&define.amd?define(["exports","d3-array","vega-dataflow","vega-util"],r):r((e.vega=e.vega||{},e.vega.transforms={}),e.d3,e.vega,e.vega)}(this,function(e,v,r,n){"use strict";function g(e){return new Uint32Array(e)}function t(e,r,n){var i=(r<257?function(e){return new Uint8Array(e)}:r<65537?function(e){return new Uint16Array(e)}:g)(e);return n&&i.set(n),i}function M(e,r,n){var s=1<<r;return{one:s,zero:~s,range:n.slice(),bisect:e.bisect,index:e.index,size:e.size,onAdd:function(e,r){var n,i=this.bisect(this.range,e.value),t=e.index,a=i[0],o=i[1],f=t.length;for(n=0;n<a;++n)r[t[n]]|=s;for(n=o;n<f;++n)r[t[n]]|=s;return this}}}function z(){var c=g(0),h=[],m=0;return{insert:function(e,r,n){if(!r.length)return[];var i,t,a,o,f,s=m,u=r.length,l=Array(u),d=g(u);for(a=0;a<u;++a)l[a]=e(r[a]),d[a]=a;if(f=d,(o=l).sort.call(f,function(e,r){var n=o[e],i=o[r];return n<i?-1:i<n?1:0}),l=v.permute(o,f),s)i=h,t=c,h=Array(s+u),c=g(s+u),function(e,r,n,i,t,a,o,f,s){var u,l=0,d=0;for(u=0;l<i&&d<o;++u)r[l]<t[d]?(f[u]=r[l],s[u]=n[l++]):(f[u]=t[d],s[u]=a[d++]+e);for(;l<i;++l,++u)f[u]=r[l],s[u]=n[l];for(;d<o;++d,++u)f[u]=t[d],s[u]=a[d]+e}(n,i,t,s,l,d,u,h,c);else{if(0<n)for(a=0;a<u;++a)d[a]+=n;h=l,c=d}return m=s+u,{index:d,value:l}},remove:function(e,r){var n,i,t,a=m;for(i=0;!r[c[i]]&&i<a;++i);for(t=i;i<a;++i)r[n=c[i]]||(c[t]=n,h[t]=h[i],++t);m=a-e},bisect:function(e,r){var n;return n=r?r.length:(r=h,m),[v.bisectLeft(r,e[0],0,n),v.bisectRight(r,e[1],0,n)]},reindex:function(e){for(var r=0,n=m;r<n;++r)c[r]=e[c[r]]},index:function(){return c},size:function(){return m}}}function i(e){var n,s,i,u,l;r.Transform.call(this,(n=8,s=[],i=g(0),u=t(0,n),l=t(0,n),{data:function(){return s},seen:function(){return e=i,r=s.length,i=e.length>=r?e:((n=n||new e.constructor(r)).set(e),n);var e,r,n},add:function(e){for(var r,n=0,i=s.length,t=e.length;n<t;++n)(r=e[n])._index=i++,s.push(r)},remove:function(e,r){var n,i,t,a=s.length,o=Array(a-e),f=s;for(i=0;!r[i]&&i<a;++i)o[i]=s[i],f[i]=i;for(t=i;i<a;++i)n=s[i],r[i]?f[i]=-1:(f[i]=t,u[t]=u[i],l[t]=l[i],(o[t]=n)._index=t++),u[i]=0;return s=o,f},size:function(){return s.length},curr:function(){return u},prev:function(){return l},reset:function(e){l[e]=u[e]},all:function(){return n<257?255:n<65537?65535:4294967295},set:function(e,r){u[e]|=r},clear:function(e,r){u[e]&=~r},resize:function(e,r){(u.length<e||n<r)&&(n=Math.max(r,n),u=t(e,n,u),l=t(e,n))}}),e),this._indices=null,this._dims=null}i.Definition={type:"CrossFilter",metadata:{},params:[{name:"fields",type:"field",array:!0,required:!0},{name:"query",type:"array",array:!0,required:!0,content:{type:"number",array:!0,length:2}}]};var a=n.inherits(i,r.Transform);function o(e){r.Transform.call(this,null,e)}a.transform=function(e,r){return this._dims?e.modified("fields")||e.fields.some(function(e){return r.modified(e.fields)})?this.reinit(e,r):this.eval(e,r):this.init(e,r)},a.init=function(e,r){for(var n,i,t=e.fields,a=e.query,o=this._indices={},f=this._dims=[],s=a.length,u=0;u<s;++u)i=o[n=t[u].fname]||(o[n]=z()),f.push(M(i,u,a[u]));return this.eval(e,r)},a.reinit=function(e,r){var n,i,t,a,o,f,s,u,l,d=r.materialize().fork(),c=e.fields,h=e.query,m=this._indices,v=this._dims,g=this.value,p=g.curr(),y=g.prev(),x=g.all(),_=d.rem=d.add,b=d.mod,A=h.length,q={};if(y.set(p),r.rem.length&&(o=this.remove(e,r,d)),r.add.length&&g.add(r.add),r.mod.length)for(f={},s=0,u=(a=r.mod).length;s<u;++s)f[a[s]._index]=1;for(s=0;s<A;++s)l=c[s],(!v[s]||e.modified("fields",s)||r.modified(l.fields))&&((n=q[t=l.fname])||(m[t]=i=z(),q[t]=n=i.insert(l,r.source,0)),v[s]=M(i,s,h[s]).onAdd(n,p));for(s=0,u=g.data().length;s<u;++s)o[s]||(y[s]!==p[s]?_.push(s):f[s]&&p[s]!==x&&b.push(s));return g.mask=(1<<A)-1,d},a.eval=function(e,r){var n=r.materialize().fork(),i=this._dims.length,t=0;return r.rem.length&&(this.remove(e,r,n),t|=(1<<i)-1),e.modified("query")&&!e.modified("fields")&&(t|=this.update(e,r,n)),r.add.length&&(this.insert(e,r,n),t|=(1<<i)-1),r.mod.length&&(this.modify(r,n),t|=(1<<i)-1),this.value.mask=t,n},a.insert=function(e,r,n){var i,t,a,o=r.add,f=this.value,s=this._dims,u=this._indices,l=e.fields,d={},c=n.add,h=f.size(),m=h+o.length,v=s.length;f.resize(m,v),f.add(o);var g=f.curr(),p=f.prev(),y=f.all();for(i=0;i<v;++i)a=d[t=l[i].fname]||(d[t]=u[t].insert(l[i],o,h)),s[i].onAdd(a,g);for(;h<m;++h)p[h]=y,g[h]!==y&&c.push(h)},a.modify=function(e,r){var n,i,t,a=r.mod,o=this.value,f=o.curr(),s=o.all(),u=e.mod;for(n=0,i=u.length;n<i;++n)f[t=u[n]._index]!==s&&a.push(t)},a.remove=function(e,r,n){var i,t,a,o,f=this._indices,s=this.value,u=s.curr(),l=s.prev(),d=s.all(),c={},h=n.rem,m=r.rem;for(i=0,t=m.length;i<t;++i)c[a=m[i]._index]=1,l[a]=o=u[a],o!==(u[a]=d)&&h.push(a);for(a in f)f[a].remove(t,c);return this.reindex(r,t,c),c},a.reindex=function(e,n,i){var t=this._indices,a=this.value;e.runAfter(function(){var e=a.remove(n,i);for(var r in t)t[r].reindex(e)})},a.update=function(e,r,n){var i,t,a=this._dims,o=e.query,f=r.stamp,s=a.length,u=0;for(t=n.filters=0;t<s;++t)e.modified("query",t)&&(i=t,++u);if(1===u)u=a[i].one,this.incrementOne(a[i],o[i],n.add,n.rem);else for(u=t=0;t<s;++t)e.modified("query",t)&&(u|=a[t].one,this.incrementAll(a[t],o[t],f,n.add),n.rem=n.add);return u},a.incrementAll=function(e,r,n,i){var t,a,o,f=this.value,s=f.seen(),u=f.curr(),l=f.prev(),d=e.index(),c=e.bisect(e.range),h=e.bisect(r),m=h[0],v=h[1],g=c[0],p=c[1],y=e.one;if(m<g)for(t=m,a=Math.min(g,v);t<a;++t)s[o=d[t]]!==n&&(l[o]=u[o],s[o]=n,i.push(o)),u[o]^=y;else if(g<m)for(t=g,a=Math.min(m,p);t<a;++t)s[o=d[t]]!==n&&(l[o]=u[o],s[o]=n,i.push(o)),u[o]^=y;if(p<v)for(t=Math.max(m,p),a=v;t<a;++t)s[o=d[t]]!==n&&(l[o]=u[o],s[o]=n,i.push(o)),u[o]^=y;else if(v<p)for(t=Math.max(g,v),a=p;t<a;++t)s[o=d[t]]!==n&&(l[o]=u[o],s[o]=n,i.push(o)),u[o]^=y;e.range=r.slice()},a.incrementOne=function(e,r,n,i){var t,a,o,f=this.value.curr(),s=e.index(),u=e.bisect(e.range),l=e.bisect(r),d=l[0],c=l[1],h=u[0],m=u[1],v=e.one;if(d<h)for(t=d,a=Math.min(h,c);t<a;++t)f[o=s[t]]^=v,n.push(o);else if(h<d)for(t=h,a=Math.min(d,m);t<a;++t)f[o=s[t]]^=v,i.push(o);if(m<c)for(t=Math.max(d,m),a=c;t<a;++t)f[o=s[t]]^=v,n.push(o);else if(c<m)for(t=Math.max(h,c),a=m;t<a;++t)f[o=s[t]]^=v,i.push(o);e.range=r.slice()},o.Definition={type:"ResolveFilter",metadata:{},params:[{name:"ignore",type:"number",required:!0,description:"A bit mask indicating which filters to ignore."},{name:"filter",type:"object",required:!0,description:"Per-tuple filter bitmaps from a CrossFilter transform."}]},n.inherits(o,r.Transform).transform=function(e,r){var n=~(e.ignore||0),i=e.filter,t=i.mask;if(0==(t&n))return r.StopPropagation;var a=r.fork(r.ALL),o=i.data(),f=i.curr(),s=i.prev(),u=function(e){return f[e]&n?null:o[e]};return a.filter(a.MOD,u),t&t-1?(a.filter(a.ADD,function(e){var r=f[e]&n;return!r&&r^s[e]&n?o[e]:null}),a.filter(a.REM,function(e){var r=f[e]&n;return r&&!(r^r^s[e]&n)?o[e]:null})):(a.filter(a.ADD,u),a.filter(a.REM,function(e){return(f[e]&n)===t?o[e]:null})),a.filter(a.SOURCE,function(e){return u(e._index)})},e.crossfilter=i,e.resolvefilter=o,Object.defineProperty(e,"__esModule",{value:!0})});