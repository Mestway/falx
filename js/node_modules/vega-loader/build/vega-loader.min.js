!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("d3-dsv"),require("topojson-client"),require("vega-util"),require("d3-time-format")):"function"==typeof define&&define.amd?define(["exports","d3-dsv","topojson-client","vega-util","d3-time-format"],t):t(e.vega={},e.d3,e.topojson,e.vega,e.d3)}(this,function(e,n,i,s,c){"use strict";var l=/^([A-Za-z]+:)?\/\//,d="file://";function t(e,n){var r=this;return r.sanitize(e,n).then(function(e){var t=e.href;return e.localFile?r.file(t):r.http(t,n)})}function r(f,a){return a=s.extend({},this.options,a),new Promise(function(e,t){var n,r,o,i,u={href:null};null!=f&&"string"==typeof f?(r=l.test(f),(i=a.baseURL)&&!r&&(h(f,"/")||"/"===i[i.length-1]||(f="/"+f),f=i+f),o=(n=h(f,d))||"file"===a.mode||"http"!==a.mode&&!r&&p(),n?f=f.slice(d.length):h(f,"//")&&("file"===a.defaultProtocol?(f=f.slice(2),o=!0):f=(a.defaultProtocol||"http")+":"+f),Object.defineProperty(u,"localFile",{value:!!o}),u.href=f,a.target&&(u.target=a.target+""),e(u)):t("Sanitize failure, invalid URI: "+s.stringValue(f))})}function o(e,t){return(n=e,r=s.extend({},this.options.http,t),o="function"==typeof fetch?fetch:require("node-fetch"),o?o(n,r):Promise.reject("No fetch method available.")).then(function(e){if(!e.ok)throw e.status+""+e.statusText;return e.text()});var n,r,o}function u(t){return new Promise(function(n,r){var e=p();e?e.readFile(t,function(e,t){e?r(e):n(t)}):r("No file system access for "+t)})}function p(){var e="function"==typeof require&&require("fs");return e&&s.isFunction(e.readFile)?e:null}function h(e,t){return null!=e&&0===e.lastIndexOf(t,0)}var m={boolean:s.toBoolean,integer:s.toNumber,number:s.toNumber,date:s.toDate,string:s.toString,unknown:s.identity},g=[function(e){return"true"===e||"false"===e||!0===e||!1===e},function(e){return a(e)&&(e=+e)==~~e},a,function(e){return!isNaN(Date.parse(e))}],v=["boolean","integer","number","date"];function f(e,t){if(!e||!e.length)return"unknown";var n,r,o,i,u=0,f=e.length,a=g.length,s=g.map(function(e,t){return t+1});for(r=0,f=e.length;r<f;++r)for(n=t?e[r][t]:e[r],o=0;o<a;++o)if(s[o]&&(null!=(i=n)&&i==i)&&!g[o](n)&&(s[o]=0,++u===g.length))return"string";return u=s.reduce(function(e,t){return 0===e?t:e},0)-1,v[u]}function y(n,e){return e.reduce(function(e,t){return e[t]=f(n,t),e},{})}function a(e){return!(isNaN(+e)||e instanceof Date)}function b(r){return function(e,t){var n={delimiter:r};return j(e,t?s.extend(t,n):n)}}function j(e,t){return t.header&&(e=t.header.map(s.stringValue).join(t.delimiter)+"\n"+e),n.dsvFormat(t.delimiter).parse(e+"")}function O(e,t){var n,r,o,i=t&&t.property?s.field(t.property):s.identity;return!s.isObject(e)||(o=e,"function"==typeof Buffer&&s.isFunction(Buffer.isBuffer)&&Buffer.isBuffer(o))?i(JSON.parse(e)):(n=i(e),r&&r.copy?JSON.parse(JSON.stringify(n)):n)}var N={dsv:j,csv:b(","),tsv:b("\t"),json:O,topojson:function(e,t){var n,r,o;return e=O(e,t),n=t&&(o=t.feature)?i.feature:t&&(o=t.mesh)?i.mesh:s.error("Missing TopoJSON feature or mesh parameter."),(r=(r=e.objects[o])?n(e,r):s.error("Invalid TopoJSON object: "+o))&&r.features||[r]}};function P(e,t){return 1<arguments.length?(N[e]=t,this):N.hasOwnProperty(e)?N[e]:null}e.loader=function(e){return{options:e||{},sanitize:r,load:t,file:u,http:o}},e.read=function(e,t,n){var r=P((t=t||{}).type||"json");return r||s.error("Unknown data format type: "+t.type),e=r(e,t),t.parse&&function(e,o,i){if(e.length){i=i||c.timeParse;var t,n,r,u,f,a,s,l=e.columns||Object.keys(e[0]);for("auto"===o&&(o=y(e,l)),l=Object.keys(o),t=l.map(function(e){var t,n,r=o[e];if(r&&(0===r.indexOf("date:")||0===r.indexOf("utc:")))return("'"===(n=(t=r.split(/:(.+)?/,2))[1])[0]&&"'"===n[n.length-1]||'"'===n[0]&&'"'===n[n.length-1])&&(n=n.slice(1,-1)),"utc"===t[0]?c.utcParse(n):i(n);if(!m[r])throw Error("Illegal format pattern: "+e+":"+r);return m[r]}),u=0,a=e.length,s=l.length;u<a;++u)for(n=e[u],f=0;f<s;++f)r=l[f],n[r]=t[f](n[r])}}(e,t.parse,n),e.hasOwnProperty("columns")&&delete e.columns,e},e.inferType=f,e.inferTypes=y,e.typeParsers=m,e.format=N,e.formats=P,Object.defineProperty(e,"__esModule",{value:!0})});